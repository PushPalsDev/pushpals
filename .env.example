# PushPals Environment
# Copy this file to `.env` and uncomment values you want to override.
# Bun loads `.env` from the repository root.

# -----------------------------------------------------------------------------
# Data paths
# -----------------------------------------------------------------------------
# Base directory for app state (SQLite files, SourceControlManager state, etc.).
# Default: <repo>/outputs/data
# PUSHPALS_DATA_DIR=./outputs/data

# Override specific DB locations (absolute path or path relative to PUSHPALS_DATA_DIR).
# Server DB. Default: <data_dir>/pushpals.db
# PUSHPALS_DB_PATH=
# RemoteBuddy idempotency DB. Default: <data_dir>/remotebuddy-state.db
# REMOTEBUDDY_DB_PATH=

# -----------------------------------------------------------------------------
# Server / session / auth
# -----------------------------------------------------------------------------
# HTTP port for apps/server.
# Default: 3001
# PUSHPALS_PORT=3001

# Shared session id used by server/agents by default.
# Default: dev
# PUSHPALS_SESSION_ID=dev

# Agent status heartbeat interval in milliseconds used to refresh liveness in the UI.
# Default behavior in code is low-frequency (120000ms) and clamps to >=30000ms when enabled.
# Set to 0 to disable heartbeats globally.
# PUSHPALS_STATUS_HEARTBEAT_MS=120000

# Auto-recover claimed jobs when their worker heartbeat goes stale.
# Claimed jobs older than this threshold (with stale/missing worker heartbeat) are
# automatically marked failed and broadcast as `job_failed`.
# Default: 120000
# PUSHPALS_STALE_CLAIM_TTL_MS=120000
#
# Minimum interval between stale-claim sweeps while handling server requests.
# Default: 5000
# PUSHPALS_STALE_CLAIM_SWEEP_INTERVAL_MS=5000

# Client-side session id override (Expo requires EXPO_PUBLIC_ prefix).
# If unset, client follows its built-in default flow.
# EXPO_PUBLIC_PUSHPALS_SESSION_ID=dev

# Client API base URL (Expo app).
# Default: http://localhost:3001
EXPO_PUBLIC_PUSHPALS_URL=http://localhost:3001

# LocalBuddy URL used by client message send flow.
# Default: http://localhost:3003
EXPO_PUBLIC_LOCAL_AGENT_URL=http://localhost:3003

# Client trace panel: number of latest trace lines kept in compacted view.
# Default: 100 (clamped to 20..500)
# EXPO_PUBLIC_PUSHPALS_TRACE_TAIL_LINES=100

# `EXPO_OS` is injected by Expo/Metro at build time and is not user-configured.

# LocalBuddy HTTP port.
# Default: 3003
LOCAL_AGENT_PORT=3003

# Optional LocalBuddy heartbeat override (ms). Uses PUSHPALS_STATUS_HEARTBEAT_MS when unset.
# LOCALBUDDY_STATUS_HEARTBEAT_MS=120000

# Optional bearer token used by server and agents.
# If set, clients/agents must send Authorization: Bearer <token>.
# PUSHPALS_AUTH_TOKEN=

# Verbose HTTP debug logging (server-side claim/poll visibility).
# Any truthy value (1/true/yes/on) enables.
# DEBUG=1
# PUSHPALS_DEBUG_HTTP=1

# Base URL used by components that read PUSHPALS_SERVER_URL.
# Default: http://localhost:3001
PUSHPALS_SERVER_URL=http://localhost:3001

# Smoke-test script server URL (scripts/smoke-test.ts).
# Default: http://localhost:3001
PUSHPALS_URL=http://localhost:3001

# -----------------------------------------------------------------------------
# LLM backend and per-service model config
# -----------------------------------------------------------------------------
# Backends: lmstudio | ollama
#
# LocalBuddy model config.
LOCALBUDDY_LLM_BACKEND=lmstudio
LOCALBUDDY_LLM_ENDPOINT=http://127.0.0.1:1234
LOCALBUDDY_LLM_MODEL=gpt-5-distill-qwen3-1.7b-instruct
LOCALBUDDY_LLM_API_KEY=lmstudio

# RemoteBuddy model config.
REMOTEBUDDY_LLM_BACKEND=lmstudio
REMOTEBUDDY_LLM_ENDPOINT=http://127.0.0.1:1234
REMOTEBUDDY_LLM_MODEL=gpt-5-distill-qwen3-1.7b-instruct
REMOTEBUDDY_LLM_API_KEY=lmstudio

# WorkerPal/OpenHands model config.
# For LM Studio/OpenAI-compatible backends this should be the base URL
# (e.g. http://127.0.0.1:1234 or http://127.0.0.1:1234/v1).
WORKERPALS_LLM_BACKEND=lmstudio
WORKERPALS_LLM_ENDPOINT=http://127.0.0.1:1234
WORKERPALS_LLM_MODEL=zai-org/glm-4.7-flash
WORKERPALS_LLM_API_KEY=lmstudio

# LM Studio oversized-context strategy uses automatic batch packing.
# Optional batching controls:
# PUSHPALS_LMSTUDIO_BATCH_CHUNK_TOKENS=1800
# PUSHPALS_LMSTUDIO_BATCH_MEMORY_CHARS=9000
# PUSHPALS_LMSTUDIO_BATCH_TAIL_MESSAGES=3

# Ollama example:
# LOCALBUDDY_LLM_BACKEND=ollama
# LOCALBUDDY_LLM_ENDPOINT=http://127.0.0.1:11434/api/chat
# LOCALBUDDY_LLM_MODEL=qwen2.5-coder:7b
# LOCALBUDDY_LLM_API_KEY=
# REMOTEBUDDY_LLM_BACKEND=ollama
# REMOTEBUDDY_LLM_ENDPOINT=http://127.0.0.1:11434/api/chat
# REMOTEBUDDY_LLM_MODEL=qwen2.5-coder:7b
# REMOTEBUDDY_LLM_API_KEY=
# WORKERPALS_LLM_BACKEND=ollama
# WORKERPALS_LLM_ENDPOINT=http://127.0.0.1:11434/api/chat
# WORKERPALS_LLM_MODEL=qwen2.5-coder:7b
# WORKERPALS_LLM_API_KEY=

# Startup LLM preflight behavior (`bun run start`):
# - Verifies configured LLM endpoints are reachable before launching services.
# - If backend is lmstudio and endpoint is local, start script can auto-launch LM Studio headless mode.
# - `bun run start -c` performs a clean run by deleting runtime state in PUSHPALS_DATA_DIR first.
# Skip preflight entirely (not recommended):
# PUSHPALS_SKIP_LLM_PREFLIGHT=1

# Allow `bun run start -c` to delete PUSHPALS_DATA_DIR when that path is outside
# the repository root. Default: disabled for safety.
# PUSHPALS_ALLOW_EXTERNAL_CLEAN=1

# Auto-start LM Studio headless server when endpoint is localhost.
# Default: enabled
# PUSHPALS_AUTO_START_LMSTUDIO=1

# Optional LM Studio CLI name (`lms` by default).
# PUSHPALS_LMSTUDIO_CLI=lms

# Optional port passed to LM Studio headless start.
# Default derives from REMOTEBUDDY_LLM_ENDPOINT.
# PUSHPALS_LMSTUDIO_PORT=1234

# Optional additional args appended to `lms server start`.
# Example: --cors
# PUSHPALS_LMSTUDIO_START_ARGS=

# Optional readiness timeout for auto-started LM Studio.
# Default: 120000
# PUSHPALS_LMSTUDIO_READY_TIMEOUT_MS=120000

# -----------------------------------------------------------------------------
# RemoteBuddy scheduler (WorkerPals routing / autoscaling)
# -----------------------------------------------------------------------------
# Max WorkerPals that RemoteBuddy should schedule against.
# If online workers are below this cap and auto-spawn is enabled, it can launch
# additional WorkerPal processes.
# Default: 1
REMOTEBUDDY_MAX_WORKERPALS=3

# Allow RemoteBuddy to spawn additional WorkerPals when no idle worker exists.
# Default: 1 (enabled)
# REMOTEBUDDY_AUTO_SPAWN_WORKERPALS=1

# How long RemoteBuddy waits for an idle WorkerPal before enqueueing without pinning.
# Default: 15000
# REMOTEBUDDY_WAIT_FOR_WORKERPAL_MS=15000

# WorkerPal online heartbeat TTL used by scheduler to treat a WorkerPal as online.
# Default: 15000
# REMOTEBUDDY_WORKERPAL_ONLINE_TTL_MS=15000

# How long RemoteBuddy waits for a newly spawned WorkerPal to register and become idle.
# Default: 10000
# REMOTEBUDDY_WORKERPAL_STARTUP_TIMEOUT_MS=10000

# Spawned WorkerPals runtime mode (used only for workers launched by RemoteBuddy).
# Default docker mode is enabled/required.
REMOTEBUDDY_WORKERPAL_DOCKER=1
REMOTEBUDDY_WORKERPAL_REQUIRE_DOCKER=1
# Worker image rebuild policy used by `bun run start`:
# - auto (default): rebuild only when worker runtime inputs changed
# - always: rebuild every startup
# - never: never rebuild if image already exists
# PUSHPALS_WORKER_IMAGE_REBUILD=auto
# Optional image override for spawned WorkerPals.
# REMOTEBUDDY_WORKERPAL_IMAGE=pushpals-worker-sandbox:latest

# Optional overrides for spawned WorkerPals polling/heartbeat/labels.
# RemoteBuddy request-queue poll interval.
# REMOTEBUDDY_POLL_MS=2000
# Optional RemoteBuddy heartbeat override (ms). Uses PUSHPALS_STATUS_HEARTBEAT_MS when unset.
# REMOTEBUDDY_STATUS_HEARTBEAT_MS=120000
# REMOTEBUDDY_WORKERPAL_POLL_MS=2000
# REMOTEBUDDY_WORKERPAL_HEARTBEAT_MS=5000
# REMOTEBUDDY_WORKERPAL_LABELS=docker,default

# -----------------------------------------------------------------------------
# Integration branch and SourceControlManager behavior
# -----------------------------------------------------------------------------
# Shared integration branch used by:
# - startup precheck in `bun run start`
# - WorkerPals default worktree base ref (`origin/<integration-branch>`)
# - SourceControlManager default merge target (unless SOURCE_CONTROL_MANAGER_MAIN_BRANCH overrides it)
# Default: main_agents
PUSHPALS_INTEGRATION_BRANCH=main_agents

# Base branch used when bootstrapping a missing integration branch.
# Startup and SourceControlManager create integration branch from origin/<base-branch>.
# Default: main
PUSHPALS_INTEGRATION_BASE_BRANCH=main

# On `bun run start`, force integration branch sync with base branch before
# launching RemoteBuddy/WorkerPals:
# - fast-forward via pull when possible
# - otherwise merge base branch into integration branch and push
# Startup aborts on any pull/merge/push error.
# Default: enabled
# PUSHPALS_SYNC_INTEGRATION_WITH_MAIN=1

# Optional SourceControlManager target-branch override.
# If unset, SourceControlManager uses PUSHPALS_INTEGRATION_BRANCH.
SOURCE_CONTROL_MANAGER_MAIN_BRANCH=main_agents

# Important relationship note:
# SOURCE_CONTROL_MANAGER_MAIN_BRANCH is the branch SourceControlManager merges into and pushes.
# During bootstrap of a missing integration branch, we set local branch upstream with:
#   git branch --set-upstream-to origin/<base-branch> <integration-branch>
# That upstream tracks where the integration branch was seeded from.
# SourceControlManager still pushes SOURCE_CONTROL_MANAGER_MAIN_BRANCH to origin.

# Skip SourceControlManager clean-repo safety guard (dev-only).
# Also available as CLI flag: --skip-clean-check
SOURCE_CONTROL_MANAGER_SKIP_CLEAN_CHECK=1

# Optional SourceControlManager heartbeat override (ms). Uses PUSHPALS_STATUS_HEARTBEAT_MS when unset.
# SOURCE_CONTROL_MANAGER_STATUS_HEARTBEAT_MS=120000

# Repository path used by SourceControlManager git operations.
# Strongly recommended: dedicated worktree path so SourceControlManager never switches
# branches in your active workspace.
# Default when unset:
#   <repo>/.worktrees/source_control_manager
# If missing, it is auto-created when running `bun run start` or SourceControlManager.
# SOURCE_CONTROL_MANAGER_REPO_PATH=

# Disable pushing integration branch after successful merge/checks.
# Default behavior is to push.
# SOURCE_CONTROL_MANAGER_NO_PUSH=1

# Auto-open (or reuse existing) PR from integration branch -> base branch
# after SourceControlManager successfully pushes integration branch.
# Default: enabled
# Set to 1 to disable.
# SOURCE_CONTROL_MANAGER_DISABLE_AUTO_PR=1

# PR base branch for SourceControlManager auto-PR flow.
# Default: main
# SOURCE_CONTROL_MANAGER_PR_BASE_BRANCH=main

# Optional PR title/body override for SourceControlManager auto-PR.
# If unset, SourceControlManager generates a default title/body.
# SOURCE_CONTROL_MANAGER_PR_TITLE=PushPals: merge main_agents into main
# SOURCE_CONTROL_MANAGER_PR_BODY=Automated PR opened by SourceControlManager.

# Open auto-created PR as draft.
# Default: disabled
# SOURCE_CONTROL_MANAGER_PR_DRAFT=1

# Auto-approve SourceControlManager creating missing integration branch from origin/<base-branch>.
# If unset, SourceControlManager prompts for interactive consent.
# SOURCE_CONTROL_MANAGER_AUTO_CREATE_MAIN_BRANCH=1

# Auto-approve `bun run start` creating/pushing missing origin/<integration-branch>.
# If unset, start prompts for interactive consent.
# PUSHPALS_AUTO_CREATE_INTEGRATION_BRANCH=1

# Skip `gh auth status/login` preflight in `bun run start`.
# If push is enabled and no token is set, start otherwise prompts/blocks.
# PUSHPALS_SKIP_GH_AUTH_CHECK=1

# GitHub token used by SourceControlManager and optional WorkerPals branch push.
# Fallback order used by code: PUSHPALS_GIT_TOKEN -> GITHUB_TOKEN -> GH_TOKEN
# If none are set and GitHub CLI is installed/authenticated, SourceControlManager
# can fall back to `gh auth token` for PR creation.
# PUSHPALS_GIT_TOKEN=
# GITHUB_TOKEN=
# GH_TOKEN=
# Internal container token (set automatically by WorkerPals Docker executor).
# Only set directly if you run the Docker job runner manually.
# GIT_TOKEN=

# -----------------------------------------------------------------------------
# WorkerPals / OpenHands / Docker
# -----------------------------------------------------------------------------
# WorkerPals execution backend.
# openhands = Python OpenHands wrapper.
# Default: openhands
# WORKERPALS_EXECUTOR=openhands

# Optional: push WorkerPals agent branches to origin during commit creation.
# Default: disabled (local branches only).
# WORKERPALS_PUSH_AGENT_BRANCH=1

# Require WorkerPals branch push success (implies WORKERPALS_PUSH_AGENT_BRANCH).
# If push fails, job is treated as failed.
# WORKERPALS_REQUIRE_PUSH=1

# Python interpreter used to launch the OpenHands wrapper script.
# In Docker image this is typically /opt/openhands-venv/bin/python.
# WORKERPALS_OPENHANDS_PYTHON=python

# Python interpreter used inside OpenHands workspace command snippets.
# In Docker image this is typically /opt/openhands-venv/bin/python3.
# WORKERPALS_OPENHANDS_WORKSPACE_PYTHON=python3

# Timeout for OpenHands wrapper job execution in milliseconds.
# Default: 1800000 (30 minutes)
# WORKERPALS_OPENHANDS_TIMEOUT_MS=1800000

# Local LLM retry/timeout tuning for OpenHands task.execute mode.
# These defaults are auto-applied for local endpoints to fail fast on connectivity
# issues (instead of waiting until outer docker timeout).
# WORKERPALS_OPENHANDS_LLM_NUM_RETRIES=2
# WORKERPALS_OPENHANDS_LLM_RETRY_MULTIPLIER=1.5
# WORKERPALS_OPENHANDS_LLM_RETRY_MIN_WAIT=1
# WORKERPALS_OPENHANDS_LLM_RETRY_MAX_WAIT=4
# WORKERPALS_OPENHANDS_LLM_TIMEOUT_SEC=120

# Max planning/execution steps for OpenHands agent task.execute mode.
# Default: 30
# WORKERPALS_OPENHANDS_AGENT_MAX_STEPS=30

# Task message shaping for OpenHands task.execute.
# Default: none (send only raw instruction to reduce context pressure on 4k models).
# Options:
# - none: instruction only (recommended for LM Studio / small context windows)
# - compact: prepend prompts/workerpals/openhands_task_execute_system_prompt.md
# WORKERPALS_OPENHANDS_TASK_PROMPT_MODE=none

# If instruction text exceeds this many characters, WorkerPals writes the full
# instruction to workspace/workerpal_requests/* and sends OpenHands a short
# "read this file first" handoff message.
# Set to 0 to disable file handoff.
# Default: 1800
# WORKERPALS_OPENHANDS_LARGE_INSTRUCTION_CHARS=1800

# Agent prompt profile for OpenHands task.execute.
# - minimal: use compact system/security prompt templates from prompts/workerpals
# - default: use OpenHands SDK built-in prompt templates
# Defaults to `minimal` for local endpoints to reduce n_ctx overflow risk.
# WORKERPALS_OPENHANDS_PROMPT_PROFILE=minimal

# Optional browser automation toolset (OpenHands BrowserToolSet via browser-use).
# Requires the worker Docker image to include Playwright runtime (provided by current Dockerfile).
# Default: disabled
# WORKERPALS_OPENHANDS_ENABLE_BROWSER_TOOL=1

# Optional MCP connector support for OpenHands agents.
# You can provide a full MCP config object directly (FastMCP MCPConfig format).
# Example shape: {"mcpServers":{"docs":{"url":"https://example.com/mcp","transport":"streamable-http"}}}
# WORKERPALS_OPENHANDS_MCP_CONFIG_JSON=
#
# Or enable a simple web/doc MCP shortcut with dedicated vars:
# WORKERPALS_OPENHANDS_ENABLE_WEB_MCP=1
# WORKERPALS_OPENHANDS_WEB_MCP_URL=https://your-mcp-endpoint.example/mcp
# WORKERPALS_OPENHANDS_WEB_MCP_NAME=web-search
# WORKERPALS_OPENHANDS_WEB_MCP_TRANSPORT=streamable-http
# WORKERPALS_OPENHANDS_WEB_MCP_AUTH_TOKEN=
# WORKERPALS_OPENHANDS_WEB_MCP_HEADERS_JSON={"x-api-key":"replace-me"}
# WORKERPALS_OPENHANDS_WEB_MCP_TIMEOUT_SEC=30

# WorkerPal heartbeat interval in milliseconds. Lower values make worker liveness
# and scheduler routing more responsive but increase server heartbeat traffic.
# Default: 5000
# WORKERPALS_HEARTBEAT_MS=5000

# WorkerPal request-queue poll interval.
# Default: 2000
# WORKERPALS_POLL_MS=2000

# Optional labels advertised by WorkerPals heartbeats (comma-separated).
# Useful for routing or diagnostics.
WORKERPALS_LABELS=docker,openhands

# Require Docker mode for WorkerPals startup.
# If enabled and Docker isn't usable, WorkerPals exits instead of falling back.
WORKERPALS_REQUIRE_DOCKER=1

# Docker image used by WorkerPals docker executor.
# Default: pushpals-worker-sandbox:latest
# WORKERPALS_DOCKER_IMAGE=pushpals-worker-sandbox:latest

# Job timeout for docker executor containers (milliseconds).
# Default: 1860000 (~31 minutes, includes headroom for structured timeout reporting)
# WORKERPALS_DOCKER_TIMEOUT_MS=1860000

# Warm OpenHands agent startup timeout (milliseconds) inside the reusable
# WorkerPal container before we treat startup as failed and recreate once.
# Default: 45000 (clamped to 10000..180000)
# WORKERPALS_DOCKER_AGENT_STARTUP_TIMEOUT_MS=45000

# Docker network mode for warm WorkerPals container.
# Use `bridge` to allow OpenHands/LiteLLM access to host LLM endpoints
# (e.g., host.docker.internal:1234 for LM Studio).
# Set to `none` only for strict isolation when no networked LLM access is needed.
# Default: bridge
# WORKERPALS_DOCKER_NETWORK_MODE=bridge

# Optional outbound proxy configuration forwarded into WorkerPal Docker containers.
# Set these only if your environment requires a proxy for internet access.
# HTTP_PROXY=
# HTTPS_PROXY=
# NO_PROXY=
# ALL_PROXY=

# Warm container idle shutdown timeout (milliseconds).
# WorkerPals keeps a reusable Docker container alive between jobs and only
# shuts it down after this much inactivity.
# Default: 600000 (10 minutes)
# WORKERPALS_DOCKER_IDLE_TIMEOUT_MS=600000

# Skip WorkerPals startup Docker git/worktree self-check.
# Default: self-check runs when docker mode is enabled.
# WORKERPALS_SKIP_DOCKER_SELF_CHECK=1

# Base ref for WorkerPals job worktrees.
# Default: origin/<PUSHPALS_INTEGRATION_BRANCH> (with runtime fallbacks).
# WORKERPALS_BASE_REF=origin/main_agents
